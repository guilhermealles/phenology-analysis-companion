# -*- coding: utf-8 -*-
# -*- mode: org -*-

#+TITLE: Companion Scripts
#+AUTHOR: Alles et al.

#+STARTUP: overview indent

* Scripts
:PROPERTIES:
:header-args: :tangle-mode (identity #o755)
:END:

This directory contains all the scripts needed to reproduce the
Figures shown in the paper *Measuring Phenology Uncertainty with Large
Scale Image Processing*.

** Figures Overview


| Section | Figure | Description                             | Status  |
|---------+--------+-----------------------------------------+---------|
|       2 |      1 | Mean gcc and rcc                        | Done    |
|---------+--------+-----------------------------------------+---------|
|       3 |      2 | PhenoVis CPM                            | Done    |
|---------+--------+-----------------------------------------+---------|
|       4 |      4 | CPM Representation                      | Pending |
|       4 |      5 | CPMs with multiple metrics              | Pending |
|       4 |      6 | CPM with the Gcc_Mean                   | Pending |
|       4 |      7 | Hourly histograms                       | Pending |
|       4 |      8 | Uncertainty level with CPM              | Pending |
|---------+--------+-----------------------------------------+---------|
|       5 |     10 | CPMs for the AHS dataset                | Pending |
|       5 |     12 | MTK Weights                             | Pending |
|       5 |     13 | Hourly CPMs for MTK                     | Pending |
|       5 |     14 | Merged CPM for MTK                      | Pending |
|       5 |     15 | Moving window weights                   | Pending |
|       5 |     16 | Merged CPM with 3 days                  | Pending |
|       5 |     17 | Averaged CPMs for multiple window sizes | Pending |
|       5 |     18 | Weights for multi-year averaging        | Pending |
|       5 |     19 | Merged CPM for multiple years           | Pending |
|       5 |     20 | Weighted CPM with uncertainty level     | Pending |
|       5 |     21 | Hourly CPMs for TKY-2011, day 145       | Pending |
|       5 |     22 | Hourly CPMs for TKY-2011, day 324       | Pending |
|       5 |     23 | Weighted CPM with uncertainty level     | Pending |
|       5 |     24 | Histogram of Gcc values                 | Pending |
|       5 |     25 | Hourly CPMs for TKY-2011, day 162       | Pending |
|       5 |     26 | Performance analysis                    | Pending |

** Section 2
*** Figure 1 (mean-gcc-rcc)

#+BEGIN_SRC R :tangle section-2/tky-2006-mean-gcc-rcc.R
#!/usr/local/bin/Rscript
library(tidyverse)

add_plot_metadata <- function (data) {
  data %>% 
  mutate(Filename = gsub('.*/', '', Name)) %>%
  mutate(Filename = gsub('.jpg', '', Filename)) %>%
  mutate(Filename = gsub('dc_', '', Filename)) %>%
  separate(Filename, sep='__', into=c('Filename', 'Camera_ID')) %>%
  separate(Filename, sep='_', into=c('Year', 'Day', 'Time', 'Dataset')) %>%
  mutate(Time = gsub('\\+.*', '', Time)) %>%
  mutate(Hour = as.integer(substr(Time, 1, 2))) %>%
  mutate(Minute = as.integer(substr(Time, 3, 4))) %>%
  mutate(Year = as.integer(Year)) %>%
  mutate(Day = as.integer(Day)) %>%
  select(-Time)
}

meanGcc <- read.csv('../../data/tky-2006-mean-gcc.csv');
meanRcc <- read.csv('../../data/tky-2006-mean-rcc.csv') %>% select(MeanRcc)

values <- cbind(meanGcc, meanRcc) %>% as.tibble %>%
  add_plot_metadata

p <- values %>%
  ggplot() +
  geom_point(aes(x = Day, y = MeanGcc, col='Gcc'), size=0.5) +
  geom_point(aes(x = Day, y = MeanRcc, col='Rcc'), size=0.5) + 
  scale_colour_manual(values=c(rgb(0, 0.75, 0),
                               rgb(0.75, 0, 0)),
                      labels=c(expression(g[cc]),
                               expression(r[cc]))
                      ) +
  ylim(0.25, 0.525) +
  xlab('Day of the year') +
  ylab('Mean coefficient') +
  theme_bw(base_size=12) +
  theme(
    plot.margin = unit(c(0,0,0,0), "cm"),
    legend.spacing = unit(0, "mm"),
    legend.justification = "left",
    legend.box.spacing = unit(0, "pt"),
    legend.box.margin = margin(0,0,0,0),
    legend.title = element_blank()
  )

df.redLines <- tribble(~X,50,165,295,345) %>% mutate(Y=1)

p2 <- p +
  geom_vline(
    data=df.redLines,
    aes(xintercept=X),
    size=0.75,
    color="red"
  ) +
  geom_label(
    data=df.redLines, aes(x=X, y=0.5125, label = X), size=2.75
  )

ggsave('tky-2006-mean-gcc-rcc.pdf', plot = p2, width = 8, height = 2.5)
#+END_SRC
*** Figure 2 (phenovis CPM)

#+BEGIN_SRC R :tangle section-2/phenovis_cpm.R
#!/usr/local/bin/Rscript
library(tidyverse)
DATAFILE <- "../../data/dc_TKY_y18_n_2015_grain100_masked.csv"

lowLimit <- 30
highLimit <- 50

data <- read_csv(
  DATAFILE,
  col_types=cols(
    .default = col_double(),
    database = col_character(),
    sequence = col_character()
  )
) %>%
  gather(variable, value, -database, -sequence, -year) %>%
  mutate(sequence = as.integer(sequence)) %>%
  mutate(variable = as.integer(gsub("X", "", variable))) %>%
  mutate(value = as.integer(value))

paletteFilename <- '../../data/phenovis.palette'
palette <- toupper(
  read.csv(
    paletteFilename,
    comment.char="?",
    header=FALSE
  )$V1
)

p <- data %>%
  filter(variable >= lowLimit, variable < highLimit) %>%
  mutate(variable = variable/100) %>%
  group_by(database, year, sequence) %>%
  arrange(variable) %>%
  mutate(Y.max = cumsum(value)/sum(value)) %>%
  mutate(Y.min = (Y.max - value/sum(value))) %>%
  ungroup %>%
  ggplot(aes(fill=as.factor(variable))) +
    geom_rect(
      aes(
        xmin=sequence,
        xmax=sequence+1,
        ymin=Y.min,
        ymax=Y.max
      )
    ) +
    ylim(0,NA) +
    theme_bw() +
    scale_fill_manual(values=palette) +
    guides(
      fill = guide_legend(
        title = expression(g[cc]),
        title.position = "top",
        ncol = 1
      )
    ) +
    xlab("DOY") +
    coord_flip() +
    scale_x_reverse(expand=c(0,0)) +
    scale_y_continuous(expand=c(0,0)) +
    theme_bw(base_size=12) +
    theme(
      plot.margin = unit(c(0,0,0,0), "cm"),
      legend.spacing = unit(1, "mm"),
      panel.grid = element_blank(),
      legend.box.spacing = unit(0, "pt"),
      legend.box.margin = margin(0,0,0,0)
    )

ggsave('./phenovis_cpm.pdf', plot = p, width = 7, height = 6)
#+END_SRC

#+RESULTS:

** TODO Section 3
*** tky-2006-gcc-mean
